<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Dein persönliches Portal</title>
    
    <!-- Content Security Policy (CSP) -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://conversations-widget.brevo.com https://cdn.jotfor.ms 'unsafe-inline' 'unsafe-eval';
        frame-src 'self' https://conversations-widget.brevo.com https://www.youtube.com https://book.stripe.com https://buy.stripe.com https://form.jotform.com https://www.jotform.com https://submit.jotform.com https://eu-submit.jotform.com;
        img-src 'self' data: https://www.gravatar.com https://conversations-widget.brevo.com https://cdn.jotfor.ms https://files.jotform.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://conversations-widget.brevo.com https://cdn.jotfor.ms;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://recovery-worker-api.coffee-recoveryhh.workers.dev https://conversations-widget.brevo.com https://form.jotform.com https://www.jotform.com https://cdn.jotfor.ms https://submit.jotform.com https://eu-submit.jotform.com;
        worker-src 'self' blob:;
        child-src 'self';
    ">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <style>
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background-color: #f8f7fa; }
        body { padding-top: 72px; }
        .main-content { padding-bottom: 80px; }
        ::-webkit-scrollbar { display: none; }

        .page { display: none; min-height: calc(100vh - 72px - 80px); }
        .page.active { display: block; animation: fadeIn .4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

        .nav-bar { box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); z-index: 30; }
        .nav-item.active svg, .nav-item.active .nav-text { color: #6366f1; }
        .nav-item.active .nav-text { font-weight: 600; }
        .nav-card { transition: transform 0.2s, box-shadow 0.2s; }
        .nav-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); }

        .placeholder-pulse { background-color: #e5e7eb; border-radius: 0.75rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5 } }

        .off-canvas-menu { position: fixed; top: 0; right: 0; width: 80%; max-width: 320px; height: 100%; background-color: #fff; z-index: 40; transform: translateX(100%); transition: transform .3s; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .off-canvas-menu.open { transform: translateX(0); }
        .off-canvas-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.4); z-index: 35; opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s; }
        .off-canvas-overlay.open { opacity: 1; visibility: visible; }

        .shop-card { background: linear-gradient(145deg, #ffffff, #f0f0f0); border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); transition: all .3s; }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,.15); }
        .shop-card .badge { font-size: .75rem; font-weight: 700; padding: .25rem .75rem; border-radius: 9999px; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,.1); }
        .shop-card .badge.indigo { background-color: #6366f1; }
        .shop-card .badge.green { background-color: #10b981; }
        .shop-card .price { font-size: 2.5rem; line-height: 1; font-weight: 800; color: #1a202c; }
        .shop-card .description { color: #718096; margin-top: .5rem; font-size: .875rem; }
        .shop-card .buy-button { display: block; width: 100%; text-align: center; font-weight: 600; padding: .75rem 1.25rem; border-radius: .5rem; color: #fff; transition: background-color .3s; margin-top: 1.5rem; background-color: #6366f1; }
        .shop-card .buy-button.green { background-color: #10b981; }
        .shop-card .buy-button:hover { filter: brightness(.95); }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/80 backdrop-blur-sm border-b border-gray-200">
        <div class="max-w-3xl mx-auto flex items-center justify-between h-18 px-6">
            <button id="back-button" onclick="goBack()" class="text-gray-600 hover:text-indigo-500 transition hidden" aria-label="Zurück">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            </button>
            <div class="font-bold text-gray-800 text-lg">Recovery Gruppen</div>
            <div class="flex items-center space-x-5">
                <button id="gamification-points" class="flex items-center space-x-1.5 text-gray-600 hover:text-indigo-500 transition" aria-label="Punktestand">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2L4 8l8 14 8-14-8-6z"/></svg>
                    <span class="font-semibold text-sm">...</span>
                </button>
                <button id="menu-button" onclick="toggleMenu()" class="text-gray-600 hover:text-indigo-500 transition" aria-label="Menü">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Off-Canvas Menu -->
    <div id="off-canvas-menu" class="off-canvas-menu">
        <div class="p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Menü</h2>
            <nav class="space-y-4">
                <a href="#" onclick="showPage('home'); toggleMenu(); return false;" class="block text-gray-700 font-semibold hover:text-indigo-500 transition">Home</a>
                <a href="#" onclick="showPage('monatsplanung-page'); toggleMenu(); return false;" class="block text-gray-700 font-semibold hover:text-indigo-500 transition">Monatsplanung</a>
                <a href="#" onclick="showPage('bestaetigte-termine-page'); toggleMenu(); return false;" class="block text-gray-700 font-semibold hover:text-indigo-500 transition">Bestätigte Termine</a>
                <a href="#" onclick="showPage('mein-bereich'); toggleMenu(); return false;" class="block text-gray-700 font-semibold hover:text-indigo-500 transition">Rechnungen</a>
                <a href="#" onclick="showPage('bibliothek'); toggleMenu(); return false;" class="block text-gray-700 font-semibold hover:text-indigo-500 transition">Ressourcen</a>
                <a href="#" onclick="openBrevoChat(); toggleMenu(); return false;" class="block text-gray-700 font-semibold hover:text-indigo-500 transition">Kontakt</a>
                <span class="block text-gray-400 font-semibold transition cursor-not-allowed">Gruppenpinnwand / Coming Soon</span>
                <span class="block text-gray-400 font-semibold transition cursor-not-allowed">Bonuspunkte einlösen / Coming Soon</span>
            </nav>
        </div>
    </div>
    <div id="off-canvas-overlay" class="off-canvas-overlay" onclick="toggleMenu()"></div>

    <!-- Main -->
    <div class="main-content max-w-3xl mx-auto md:rounded-b-xl">

        <!-- PAGE: HOME -->
        <div id="home" class="page active p-6">
            <header class="text-left pt-2 pb-6">
                <h1 id="user-greeting" class="text-3xl font-bold text-gray-800">Willkommen!</h1>
                <p class="text-md text-gray-500 mt-1">Schön, dass du da bist.</p>
            </header>

            <div id="news-container" class="bg-white border border-gray-200 rounded-xl p-5 mb-8 shadow-sm">
                <div class="placeholder-pulse h-16 w-full"></div>
            </div>
            
            <div id="next-appointment-container" class="bg-teal-50 border-2 border-teal-200 rounded-xl p-5 mb-8">
                <div class="placeholder-pulse h-24 w-full bg-teal-200"></div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <a href="#" onclick="showPage('monatsplanung-page'); return false;" id="link-monatsplanung" class="nav-card bg-white rounded-xl shadow-sm p-6 border border-gray-200 block">
                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    </div>
                    <h3 class="font-semibold text-lg text-gray-900">Monatsplanung</h3>
                    <p class="text-sm text-gray-500 mt-1">Plane deine Verfügbarkeit.</p>
                </a>
                <a href="#" onclick="showPage('bestaetigte-termine-page'); return false;" id="link-termine" class="nav-card bg-white rounded-xl shadow-sm p-6 border border-gray-200 block">
                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h3 class="font-semibold text-lg text-gray-900">Bestätigte Termine</h3>
                    <p class="text-sm text-gray-500 mt-1">Sieh alle Sitzungen ein.</p>
                </a>
                <a href="#" onclick="openBrevoChat(); return false;" id="link-kontakt" class="nav-card brevo-chat-trigger bg-white rounded-xl shadow-sm p-6 border border-gray-200 block sm:col-span-2">
                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-sky-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <h3 class="font-semibold text-lg text-gray-900">Kontakt</h3>
                    <p class="text-sm text-gray-500 mt-1">Direkte Nachricht an uns senden.</p>
                </a>
            </div>
        </div>

        <!-- PAGE: MONATSPLANUNG -->
        <div id="monatsplanung-page" class="page p-6">
            <header class="pt-2 pb-6">
                <h1 class="text-3xl font-bold text-gray-800">Monatsplanung</h1>
                <p class="text-gray-600 mt-2">Teile deine Verfügbarkeiten über das Formular.</p>
            </header>

            <div class="bg-white p-0 rounded-xl shadow-sm border border-gray-200">
                <!-- JotForm iFrame -->
                <iframe
                  id="JotFormIFrame-252311488402047"
                  title="Monatsplanung Donnerstag"
                  onload="window.parent.scrollTo(0,0)"
                  allowtransparency="true"
                  allow="geolocation; microphone; camera; fullscreen; payment"
                  src="https://form.jotform.com/252311488402047"
                  frameborder="0"
                  style="min-width:100%;max-width:100%;height:580px;border:none;"
                  scrolling="no">
                </iframe>
            </div>

            <!-- JotForm Embed Handler -->
            <script src="https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js"></script>
            <script>
              // Portal-ID robust lesen
              function getPortalIdFromUrl() {
                const q = location.search || '';
                const m = q.match(/[?&]id=([^&#]+)/i);
                if (!m) return '';
                return decodeURIComponent(m[1]).trim().replace(/%23$/, '').replace(/#$/, '');
              }
              (function prefillJotformWithPortalId() {
                const iframe = document.getElementById('JotFormIFrame-252311488402047');
                if (!iframe) return;
                const portalId = getPortalIdFromUrl();
                try {
                  const url = new URL(iframe.src);
                  if (portalId) {
                    // WICHTIG: Der Parameter-Name muss dem Hidden-Feld in JotForm entsprechen!
                    url.searchParams.set('portalId', portalId);
                    iframe.src = url.toString();
                  }
                } catch (e) { console.warn('Konnte JotForm-URL nicht anpassen:', e); }
                if (window.jotformEmbedHandler) {
                  window.jotformEmbedHandler("iframe[id='JotFormIFrame-252311488402047']", "https://form.jotform.com/");
                }
              })();
            </script>
        </div>

        <!-- PAGE: BESTÄTIGTE TERMINE -->
        <div id="bestaetigte-termine-page" class="page p-6">
            <header class="pt-2 pb-6">
                <h1 class="text-3xl font-bold text-gray-800">Bestätigte Termine</h1>
                <p class="text-gray-600 mt-2">Deine festen Gruppensitzungen.</p>
            </header>
            <div id="confirmed-appointments-container" class="space-y-4">
                <p class="text-center text-gray-500 mt-8">Lade Termine...</p>
            </div>
        </div>

        <!-- PAGE: SHOP -->
        <div id="shop-page" class="page p-6">
            <header class="pt-2 pb-6">
                <h1 class="text-3xl font-bold text-gray-800">Gruppenkarten kaufen</h1>
                <p class="text-gray-600 mt-2">Wähle die passende Karte für deine Bedürfnisse.</p>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="shop-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-indigo-600">5er-Karte</h3>
                        <div class="badge indigo">1 Sitzung gratis</div>
                    </div>
                    <p class="price mb-2">240 €</p>
                    <p class="description">Enthält 5 Sitzungen (inkl. 1 gratis Sitzung).</p>
                    <a href="https://buy.stripe.com/dRmdR96dj8MN1pcgLn3Je04" target="_blank" class="buy-button">
                        Jetzt kaufen
                    </a>
                </div>

                <div class="shop-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-green-600">10er-Karte</h3>
                        <div class="badge green">3 Sitzungen gratis</div>
                    </div>
                    <p class="price mb-2">420 €</p>
                    <p class="description">Enthält 10 Sitzungen (inkl. 3 gratis Sitzungen).</p>
                    <a href="https://buy.stripe.com/eVq3cv1X35ABfg252F3Je05" target="_blank" class="buy-button green">
                        Jetzt kaufen
                    </a>
                </div>
            </div>
        </div>

        <!-- PAGE: BIBLIOTHEK -->
        <div id="bibliothek" class="page p-6">
            <header class="pt-2 pb-6">
                <h1 class="text-3xl font-bold text-gray-800">Bibliothek</h1>
                <p class="text-gray-600 mt-2">Ein Ort für Ressourcen und den Austausch.</p>
            </header>
            
            <div class="space-y-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ressourcen & Hilfsmittel</h2>
                    <div id="resources-container" class="space-y-3">
                        <div class="placeholder-pulse h-16 w-full"></div>
                    </div>
                </div>

                <!-- Coming Soon - Fortschrittstracker -->
                <div class="relative bg-white p-5 rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white bg-opacity%80 backdrop-blur-sm p-4 text-center rounded-xl">
                        <span class="font-bold text-indigo-600 text-lg">Coming Soon</span>
                        <p class="text-sm text-gray-600 mt-1">Diese Funktion ist in Arbeit!</p>
                    </div>
                    <div class="flex items-center space-x-4 opacity%50">
                        <div class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-lg bg-red-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin
